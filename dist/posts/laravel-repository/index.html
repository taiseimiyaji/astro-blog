<!DOCTYPE html><html lang="ja"> <head><title>LaravelにおけるRepositoryについて再考してみる</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta name="description" content="
## はじめに

ここ最近、ツイッター上でLaravelにおいてのRepositoryの実装についての記事や意見をいくつか見かけました。  
それらの記事や意見の内容を整理しつつ、自分なりにLaravelにおけるRepositoryの実装"><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZBD90YGZ4N"></script><style>@charset "UTF-8";html{background-color:#23272f;font-size:16px;color:#f6f7f9}.header{color:#f6f7f9;justify-content:space-around;border-bottom:.5px solid}.header-link{display:flex;justify-content:space-around;font-size:1.5rem;padding:.5rem;border-color:#f6f7f9;margin:0 auto;max-width:70rem;width:94vw}.header-link div{color:#f6f7f9}.header .title{border-bottom:.5px solid;text-align:center;font-weight:700;padding:2rem;font-size:2.5rem}.card{box-sizing:border-box;background-color:#23272f;border:1px solid #F6F7F9;border-radius:1rem;display:flex;flex-direction:column;padding:2rem;gap:1rem;color:#f6f7f9}.card .title{font-size:large;overflow:inherit}.card:hover{background-color:#2d3748;color:#fff;box-shadow:0 6px 8px #00000026}.card-list{gap:1rem;flex-direction:column;display:flex}code{font-size:1rem}:root{--accent: 124, 58, 237;--accent-gradient: linear-gradient(45deg, rgb(var(--accent)), #da62c4 30%, white 60%)}html{font-family:system-ui,sans-serif}code{font-family:Menlo,Monaco,Lucida Console,Liberation Mono,DejaVu Sans Mono,Bitstream Vera Sans Mono,Courier New,monospace}.content{padding:2rem 0;margin:0 auto;max-width:70rem;width:94vw}.content .post{overflow-wrap:normal;overflow:hidden}.content p,.content ul li,.content ol li{line-height:1.7}a{color:#f6f7f9;text-decoration:none}img{width:100%}*,*:before,*:after{box-sizing:border-box}.card-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(min(250px,100%),1fr));gap:1rem;padding:1rem}.sns-button{display:flex;align-items:center;justify-content:center;background-color:#23272f;border:1px solid white;color:#fff;padding:1rem;border-radius:.5rem;box-shadow:0 4px 6px #0000001a;transition:background-color .3s ease,box-shadow .3s ease;width:100%;max-width:100%;text-align:center;font-size:1.25rem;cursor:pointer;margin:0}.sns-button:hover{background-color:#2d3748;color:#fff;box-shadow:0 6px 8px #00000026}.sns-button svg{stroke:currentColor;fill:currentColor;stroke-width:0;height:1.5em;width:1.5em;margin-right:.5rem}pre.astro-code.github-dark{background-color:#2d333b!important;overflow-x:auto;padding:1rem;border-radius:.2rem}.footer{border-top:1px solid #F6F7F9;padding:1rem;align-items:center;display:flex;max-height:2rem}.footer .copyright{order:1}.footer .icons{margin-left:auto;order:2;width:2rem;height:2rem}
html{background-color:#23272f;font-size:16px;color:#f6f7f9}.header{color:#f6f7f9;justify-content:space-around;border-bottom:.5px solid}.header-link{display:flex;justify-content:space-around;font-size:1.5rem;padding:.5rem;border-color:#f6f7f9;margin:0 auto;max-width:70rem;width:94vw}.header-link div{color:#f6f7f9}.header .title{border-bottom:.5px solid;text-align:center;font-weight:700;padding:2rem;font-size:2.5rem}.footer{border-top:1px solid #F6F7F9;padding:1rem;align-items:center;display:flex;max-height:2rem}.footer .copyright{order:1}.footer .icons{margin-left:auto;order:2;width:2rem;height:2rem}.card{box-sizing:border-box;background-color:#23272f;border:1px solid #F6F7F9;border-radius:1rem;display:flex;flex-direction:column;padding:2rem;gap:1rem;color:#f6f7f9}.card .title{font-size:large;overflow:inherit}.card:hover{background-color:#2d3748;color:#fff;box-shadow:0 6px 8px #00000026}.card-list{gap:1rem;flex-direction:column;display:flex}.content a{text-decoration:underline}.content table{width:100%;border-collapse:collapse;margin:2rem 0}.content table th,.content table td{border:1px solid #F6F7F9;padding:.5rem;text-align:left}.content table th{background-color:#f6f7f933;color:#f6f7f9;font-weight:700}.content table tr:nth-child(odd){background-color:#f6f7f91a}.content table tr:nth-child(2n){background-color:#f6f7f90d}.content blockquote{padding:1rem;margin:1rem 0;border-left:4px solid #F6F7F9;background-color:#f6f7f91a;color:#f6f7f9;font-style:italic;overflow-wrap:break-word}.content blockquote p{margin:0}.content h2{color:#f6f7f9;margin:2rem 0 1rem;font-size:1.5rem;font-weight:700;border-bottom:2px solid #F6F7F9;padding-bottom:.5rem}
</style><script type="module">window.dataLayer=window.dataLayer||[];function a(){dataLayer.push(arguments)}a("js",new Date);a("config","G-ZBD90YGZ4N");
</script></head> <!-- Google tag (gtag.js) -->  <body> <main> <div class="header"><div class="title"><a href="/">Lyricrime.com</a></div><div class="header-link"><a href="/"><div> Blog</div></a><a href="/services"><div>Services</div></a><a href="/profile"><div>Profile</div></a></div></div> <div class="content"> <div class="date">2023/07/21</div> <h1>LaravelにおけるRepositoryについて再考してみる</h1> <div class="post"> <h2 id="はじめに">はじめに</h2>
<p>ここ最近、ツイッター上でLaravelにおいてのRepositoryの実装についての記事や意見をいくつか見かけました。<br>
それらの記事や意見の内容を整理しつつ、自分なりにLaravelにおけるRepositoryの実装について再考してみたいと思います。</p>
<h2 id="repositoryとは">Repositoryとは</h2>
<p>Repositoryは「エリック・エヴァンスのドメイン駆動設計」において紹介されているモデル駆動におけるクラスの一つです。</p>
<p>概要としては、ドメインモデルを永続化する処理を抽象化するために存在します。<code>リポジトリ</code>は直訳で保管庫を意味します。</p>
<p>今回は最初にコード例を示した上で、Repositoryの実装について考えていきます。</p>
<p>参考: <a href="https://zenn.dev/kohii/articles/e4f325ed011db8">https://zenn.dev/kohii/articles/e4f325ed011db8</a></p>
<h2 id="laravelでrepositoryを実装してみる">LaravelでRepositoryを実装してみる</h2>
<h3 id="設計">設計</h3>
<p>今回は、ユーザーを管理する一連の処理を題材にRepositoryを使って実装してみます。</p>
<p>クラスは下記のように作成します</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>ユーザー(User)</span></span>
<span class="line"><span>- ID(Id)</span></span>
<span class="line"><span>- 名前(Name)</span></span>
<span class="line"><span>- メールアドレス(Email)</span></span>
<span class="line"><span></span></span></code></pre>
<p>永続化処理をRepositoryで抽象化し、具象としては以下のようなクラスを作成します。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>- UserMySQLRepository</span></span>
<span class="line"><span>- UserSQLiteRepository</span></span>
<span class="line"><span></span></span></code></pre>
<h3 id="実装">実装</h3>
<p>Userクラス</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#F97583">&#x3C;?</span><span style="color:#79B8FF">php</span></span>
<span class="line"><span style="color:#F97583">declare</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">strict_types</span><span style="color:#F97583">=</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">namespace</span><span style="color:#B392F0"> user</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">/**</span></span>
<span class="line"><span style="color:#6A737D"> * ユーザーを表現するクラス.</span></span>
<span class="line"><span style="color:#6A737D"> * DDDの文脈におけるエンティティ.</span></span>
<span class="line"><span style="color:#6A737D"> */</span></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> User</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> string</span><span style="color:#E1E4E8"> $id;</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> string</span><span style="color:#E1E4E8"> $name;</span></span>
<span class="line"><span style="color:#E1E4E8">    </span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> string</span><span style="color:#E1E4E8"> $email;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#79B8FF"> __construct</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#F97583">        string</span><span style="color:#E1E4E8"> $id,</span></span>
<span class="line"><span style="color:#F97583">        string</span><span style="color:#E1E4E8"> $name,</span></span>
<span class="line"><span style="color:#F97583">        string</span><span style="color:#E1E4E8"> $email</span></span>
<span class="line"><span style="color:#E1E4E8">    ) {</span></span>
<span class="line"><span style="color:#79B8FF">        $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">id </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $id;</span></span>
<span class="line"><span style="color:#79B8FF">        $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">name </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $name;</span></span>
<span class="line"><span style="color:#79B8FF">        $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">email </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $email;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> getId</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#F97583"> string</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">id;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> getName</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#F97583"> string</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">name;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> getEmail</span><span style="color:#E1E4E8">()</span><span style="color:#F97583">:</span><span style="color:#F97583"> string</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">email;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<p>今回はLaravelのORMであるEloquentを使って永続化処理を実装してみます。</p>
<p>Repositoryを表現するためのInterfaceを作成します。</p>
<p>このインターフェースを持つものはRepository、つまり永続化処理を抽象化したものであるということがわかります。</p>
<p>簡略化のために、今回はfindByIdとsaveのみを定義します。</p>
<p>UserRepositoryInterface</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#F97583">&#x3C;?</span><span style="color:#79B8FF">php</span></span>
<span class="line"><span style="color:#F97583">declare</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">strict_types</span><span style="color:#F97583">=</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">namespace</span><span style="color:#B392F0"> user</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">interface</span><span style="color:#B392F0"> UserRepositoryInterface</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> findById</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> $id)</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> User</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> save</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">User</span><span style="color:#E1E4E8"> $user)</span><span style="color:#F97583">:</span><span style="color:#F97583"> void</span><span style="color:#E1E4E8">;</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>具体的なRepositoryの実装です。</p>
<p>UserMySqlRepositoryクラスとUserSqliteRepositoryクラスを作成します。</p>
<p>UserMySqlRepositoryクラス</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#F97583">&#x3C;?</span><span style="color:#79B8FF">php</span></span>
<span class="line"><span style="color:#F97583">declare</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">strict_types</span><span style="color:#F97583">=</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">namespace</span><span style="color:#B392F0"> user</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> UserMySqlRepository</span><span style="color:#F97583"> implements</span><span style="color:#B392F0"> UserRepositoryInterface</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    protected</span><span style="color:#79B8FF"> \App\Models\User</span><span style="color:#E1E4E8"> $UserModel;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> string</span><span style="color:#E1E4E8"> $connection;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#79B8FF"> __construct</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">\App\Models\User</span><span style="color:#E1E4E8"> $UserModel, $connection </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> 'mysql'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#79B8FF">        $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">UserModel </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $UserModel;</span></span>
<span class="line"><span style="color:#79B8FF">        $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">connection </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $connection;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> findById</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> $id)</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> User</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        $data </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">UserModel</span><span style="color:#F97583">::</span><span style="color:#B392F0">on</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">connection)</span><span style="color:#F97583">-></span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">($id);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> new</span><span style="color:#79B8FF"> User</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">            $data</span><span style="color:#F97583">-></span><span style="color:#B392F0">getAttribute</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'id'</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">            $data</span><span style="color:#F97583">-></span><span style="color:#B392F0">getAttribute</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'name'</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">            $data</span><span style="color:#F97583">-></span><span style="color:#B392F0">getAttribute</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'email'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        );</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> save</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">User</span><span style="color:#E1E4E8"> $user)</span><span style="color:#F97583">:</span><span style="color:#F97583"> void</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#79B8FF">        $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">UserModel</span><span style="color:#F97583">::</span><span style="color:#B392F0">on</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">connection)</span><span style="color:#F97583">-></span><span style="color:#B392F0">updateOrCreate</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">            [</span><span style="color:#9ECBFF">'id'</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> $user</span><span style="color:#F97583">-></span><span style="color:#B392F0">getId</span><span style="color:#E1E4E8">()],</span></span>
<span class="line"><span style="color:#E1E4E8">            [</span></span>
<span class="line"><span style="color:#9ECBFF">                'name'</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> $user</span><span style="color:#F97583">-></span><span style="color:#B392F0">getName</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#9ECBFF">                'email'</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> $user</span><span style="color:#F97583">-></span><span style="color:#B392F0">getEmail</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">            ]</span></span>
<span class="line"><span style="color:#E1E4E8">        );</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>UserSqliteRepositoryクラス</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#F97583">&#x3C;?</span><span style="color:#79B8FF">php</span></span>
<span class="line"><span style="color:#F97583">declare</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">strict_types</span><span style="color:#F97583">=</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">namespace</span><span style="color:#B392F0"> user</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> UserSqliteRepository</span><span style="color:#F97583"> implements</span><span style="color:#B392F0"> UserRepositoryInterface</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    protected</span><span style="color:#79B8FF"> \App\Models\User</span><span style="color:#E1E4E8"> $UserModel;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#F97583"> string</span><span style="color:#E1E4E8"> $connection;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#79B8FF"> __construct</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">\App\Models\User</span><span style="color:#E1E4E8"> $UserModel, $connection </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> 'sqlite'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#79B8FF">        $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">UserModel </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $UserModel;</span></span>
<span class="line"><span style="color:#79B8FF">        $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">connection </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $connection;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> findById</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> $id)</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> User</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#E1E4E8">        $data </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">UserModel</span><span style="color:#F97583">::</span><span style="color:#B392F0">on</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">connection)</span><span style="color:#F97583">-></span><span style="color:#B392F0">find</span><span style="color:#E1E4E8">($id);</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#F97583"> new</span><span style="color:#79B8FF"> User</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">            $data</span><span style="color:#F97583">-></span><span style="color:#B392F0">getAttribute</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'id'</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">            $data</span><span style="color:#F97583">-></span><span style="color:#B392F0">getAttribute</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'name'</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#E1E4E8">            $data</span><span style="color:#F97583">-></span><span style="color:#B392F0">getAttribute</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">'email'</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">        );</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> save</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">User</span><span style="color:#E1E4E8"> $user)</span><span style="color:#F97583">:</span><span style="color:#F97583"> void</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#79B8FF">        $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">UserModel</span><span style="color:#F97583">::</span><span style="color:#B392F0">on</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">$this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">connection)</span><span style="color:#F97583">-></span><span style="color:#B392F0">updateOrCreate</span><span style="color:#E1E4E8">(</span></span>
<span class="line"><span style="color:#E1E4E8">            [</span><span style="color:#9ECBFF">'id'</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> $user</span><span style="color:#F97583">-></span><span style="color:#B392F0">getId</span><span style="color:#E1E4E8">()],</span></span>
<span class="line"><span style="color:#E1E4E8">            [</span></span>
<span class="line"><span style="color:#9ECBFF">                'name'</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> $user</span><span style="color:#F97583">-></span><span style="color:#B392F0">getName</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#9ECBFF">                'email'</span><span style="color:#F97583"> =></span><span style="color:#E1E4E8"> $user</span><span style="color:#F97583">-></span><span style="color:#B392F0">getEmail</span><span style="color:#E1E4E8">(),</span></span>
<span class="line"><span style="color:#E1E4E8">            ]</span></span>
<span class="line"><span style="color:#E1E4E8">        );</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>Repositoryはアプリケーションサービスと呼ばれるクラスから呼び出されます。</p>
<p>アプリケーションの要求に応じてサービスクラスは分割することがベターだと考えているのでここでは2つに分割します。</p>
<p>コントローラーについては今回は省略しますが、サービス同様に1コントローラー1メソッドとなるよう分割することがベターだと考えています。</p>
<p>CreateUserServiceクラス</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#F97583">&#x3C;?</span><span style="color:#79B8FF">php</span></span>
<span class="line"><span style="color:#F97583">declare</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">strict_types</span><span style="color:#F97583">=</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">namespace</span><span style="color:#B392F0"> user</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> CreateUserService</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#79B8FF"> UserRepositoryInterface</span><span style="color:#E1E4E8"> $userRepository;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#79B8FF"> __construct</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">UserRepositoryInterface</span><span style="color:#E1E4E8"> $userRepository)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#79B8FF">        $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">userRepository </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $userRepository;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> process</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">User</span><span style="color:#E1E4E8"> $user)</span><span style="color:#F97583">:</span><span style="color:#F97583"> void</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#79B8FF">        $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">userRepository</span><span style="color:#F97583">-></span><span style="color:#B392F0">save</span><span style="color:#E1E4E8">($user);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>GetUserServiceクラス</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#F97583">&#x3C;?</span><span style="color:#79B8FF">php</span></span>
<span class="line"><span style="color:#F97583">declare</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">strict_types</span><span style="color:#F97583">=</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">namespace</span><span style="color:#B392F0"> user</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> GetUserService</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    private</span><span style="color:#79B8FF"> UserRepositoryInterface</span><span style="color:#E1E4E8"> $userRepository;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#79B8FF"> __construct</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">UserRepositoryInterface</span><span style="color:#E1E4E8"> $userRepository)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#79B8FF">        $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">userRepository </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> $userRepository;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> process</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">int</span><span style="color:#E1E4E8"> $id)</span><span style="color:#F97583">:</span><span style="color:#79B8FF"> User</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#79B8FF"> $this</span><span style="color:#F97583">-></span><span style="color:#E1E4E8">userRepository</span><span style="color:#F97583">-></span><span style="color:#B392F0">findById</span><span style="color:#E1E4E8">($id);</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<h2 id="repositoryの定義を再確認">Repositoryの定義を再確認</h2>
<p>原著である「エリック・エヴァンスのドメイン駆動設計」から、Repositoryの意味するところを引用し、確認します。</p>
<blockquote>
<p>集約ルート以外のオブジェクトにグローバルなアクセスを提供してしまうと、重要な区別が台無しになる。データベースクエリを自由に行うと、実はドメインオブジェクトと集約のカプセル化に違反しかねないのだ。技術的なインフラストラクチャやデータベースアクセスの仕組みを露呈させてしまうと、クライアントが複雑になり、モデル駆動設計が不明瞭になってしまう。</p>
</blockquote>
<p>Eric Evans. エリック・エヴァンスのドメイン駆動設計 (Kindle の位置No.3526-3530). Kindle 版.</p>
<blockquote>
<p>実際のストレージや問い合わせの技術をカプセル化すること。実際に直接的なアクセスを必要とする集約ルートに対してのみ、リポジトリを提供すること。クライアントをモデルに集中させ、あらゆるオブジェクトの格納とアクセスをリポジトリに委譲すること</p>
</blockquote>
<p>Eric Evans. エリック・エヴァンスのドメイン駆動設計 (Kindle の位置No.3561-3563). Kindle 版.</p>
<p>といった記載があります。このあたりから読み取れることは、あくまでRepositoryはDDDにおける集約の単位で永続化する際に抽象化のために用いられることがわかります。</p>
<h2 id="アンチパターンを考えてみる">アンチパターンを考えてみる</h2>
<h2 id="repositoryにeloquent-modelを渡してしまう">RepositoryにEloquent Modelを渡してしまう</h2>
<p>今回記事を書くに当たってTwitterで散見されたアンチパターンに、以下のようにEloquent Modelを使用しているものがありました。</p>
<p>ここで引数に渡しているUserクラスはエンティティではなく、Eloquent ModelのUserであることに注意してください。</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="php"><code><span class="line"><span style="color:#F97583">&#x3C;?</span><span style="color:#79B8FF">php</span></span>
<span class="line"><span style="color:#F97583">declare</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">strict_types</span><span style="color:#F97583">=</span><span style="color:#79B8FF">1</span><span style="color:#E1E4E8">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">namespace</span><span style="color:#B392F0"> user</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">use</span><span style="color:#79B8FF"> App\Models\User</span><span style="color:#E1E4E8">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> BadUserRepository</span></span>
<span class="line"><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#F97583">    public</span><span style="color:#F97583"> function</span><span style="color:#B392F0"> save</span><span style="color:#E1E4E8">(</span><span style="color:#79B8FF">User</span><span style="color:#E1E4E8"> $user)</span></span>
<span class="line"><span style="color:#E1E4E8">    {</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> $user</span><span style="color:#F97583">-></span><span style="color:#B392F0">save</span><span style="color:#E1E4E8">();</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    // その他のメソッド...</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>このような実装は原著の意図するRepositoryとは異なります。</p>
<p>また、Eloquentという具体的なデータアクセス手段が外部に漏洩しているのでRepositoryである意味がありません。無駄なクラス生成とロジックの分散を行っているだけとなってしまいます。</p>
<p>どうしてこのような無駄なRepositoryを作成してしまうのかという原因を考えてみたんですが、そもそも「Repositoryパターン」という言葉が独り歩きしている印象を受けます。</p>
<p>先程確認したRepositoryの説明から、私は以下のように解釈しています。</p>
<ol>
<li>モデル駆動という考え方から、ドメインモデルをクラスの形で表現する</li>
<li>ドメインモデルは、複数の概念をまとめた「集約」として扱われることもある</li>
<li>ドメインモデルを表現したクラスはEntityと呼ばれ、各パラメータはValueObjectパターンで表現されることもある</li>
<li>このドメインモデルの永続化を抽象化するためのクラスがRepositoryである</li>
<li>Repositoryは永続化や再構築を行うが、扱うのはすべて「集約」単位である。</li>
</ol>
<p>今回のアンチパターンは、RepositoryのInterfaceの時点でEloquentを使用しており、集約ではない上に、ORMというデータアクセスに関する知識をRepository外部に漏洩している点が問題です。</p>
<h3 id="ではeloquent-modelの存在意義は">ではEloquent Modelの存在意義は?</h3>
<p>Laravelを採用する上でEloquentというのは非常に大きなメリットを持っています。</p>
<p>RailsのActiveRecordと同様に、データベースのテーブルとオブジェクトをマッピングすることができます。</p>
<p>ただ、このパターンはDDDの思想とは少し異なります。レイヤードアーキテクチャやDDDを採用する上で、データアクセスの知識をカプセル化する必要があるため、Eloquentのメリットを最大限に活かすことは難しくなってきます。</p>
<p>個人的に、Eloquentのメリットが活用できるのは、以下のような場合だと思っています。</p>
<ol>
<li>開発効率を重視し、レイヤードアーキテクチャやDDDを採用しない場合</li>
<li>ドメインモデルが実際のDBのテーブルと全く同じ構成であり、「集約」について意識しない場合</li>
</ol>
<p>プロダクトの成長に伴って、メンテナンス性を意識し始めると、Eloquentのメリットを享受することは難しくなってきます。</p>
<p>resourceと完全に一致する構成で単純なCRUDのみを行う場合は、Eloquentを採用することで開発効率を上げることができると思いますが、Railsと同様にControllerにすべてを記載し、レイヤー分けしないメリットのほうが大きいと思います。</p>
<h3 id="アンチパターンを踏みがちなケース">アンチパターンを踏みがちなケース</h3>
<p>ここからは完全に個人的な妄想と想像です。(ここまでも)</p>
<p>このアンチパターンを踏む思考は以下のようなものが挙げられます。</p>
<ul>
<li>レガシーなシステムを改善しないといけないので巷で噂の「Repositoryパターン」を採用してみる</li>
<li>DDD? レイヤードアーキテクチャ? そんなものは知らないけど、Eloquentを使っているから大丈夫だろう</li>
</ul>
<p>そもそも、「Repositoryパターン」ってなんなの？というところから疑問に感じています。<br>
あくまでRepositoryはDDDという大きな文脈に登場する役割の一つであって、GoFのデザインパターンのような特定のデザインパターンではないので、単体で活用することのできないものだと思っています。<br>
大体ネットで見かける危ない匂いのする「Repository」は「Repositoryパターン」を銀の弾丸だと盲信していて、原著やDDDの文脈に触れていない記事が多いような気がします。</p>
<p>しっかりとモデルについて考えてクラスにした上で、そのモデルを取り回す際にRepositoryを活用するというのが、私の理解です。</p>
<h3 id="laravelのコードの改善案">Laravelのコードの改善案</h3>
<p>Controllerに処理が全て詰め込まれているようなコードを改善するために、Repositoryから導入するのは良くないというのがここまでの主張ですが、どのような段階を踏んで改善していくのが良いのかを考えてみます。</p>
<p>第一段階は「UseCase」だけを取り入れることです。</p>
<p>参考: <a href="https://zenn.dev/mpyw/articles/ce7d09eb6d8117">https://zenn.dev/mpyw/articles/ce7d09eb6d8117</a></p>
<p>この段階では、Eloquentを積極的に活用するためにあえて分割する粒度を大きくしています。</p>
<p>第二段階はEloquentを捨て、DDDとレイヤードアーキテクチャにガッツリ寄せることです。</p>
<p>第一段階から飛躍していますが、やむを得ません。Laravelのお作法自体がレイヤードアーキテクチャやDDDといった設計手法とは異なっているので、そのままではなかなか改善できません。</p>
<p>この段階ではEloquent Modelを捨て、ファサードやヘルパーも捨てましょう。</p>
<p>参考: <a href="https://blog.ytake.jp.net/entry/2015/12/16/011812">https://blog.ytake.jp.net/entry/2015/12/16/011812</a></p>
<p>要件が複雑なプロジェクト?寿命が長いプロダクト?そんな場合は覚悟を決めて第二段階を採用しましょう。</p>
<p>Eloquentを採用できないの?じゃあ、Laravelを使わないほうが良いのでは？という話になってしまいますが、採用されている数の多さやそれに伴うエンジニアの多さなどから選定されることも多いと思います。今回は既存プロジェクトの改善の話なのでLaravelプロジェクトを想定しています。</p>
<p><del>立ち上げ段階でみんなちゃんと設計できて扱えるならSymfony + Doctrineでいいんじゃ</del></p>
<h2 id="余談-repositoryにeloquent-modelをdiするかどうか">【余談】 RepositoryにEloquent ModelをDIするかどうか</h2>
<p>参考: <a href="https://qiita.com/fuwasegu/items/f778a1067c941dc8baea">https://qiita.com/fuwasegu/items/f778a1067c941dc8baea</a></p>
<p>RepositoryにEloquentModelをDIするかどうかについては、いくつかの意見があります。</p>
<p>個人的には、Repositoryの中にカプセル化できるのであれば、EloquentModelの採用自体には問題はないと思っています。</p>
<p>ただし、参考記事にあるようにActiveRecordの思想のメリットを十分に享受できるとは言えず、たとえばテーブル名や接続といった一部の情報を抽象化するためにEloquentを使用することになります。</p>
<p>多少もったいない感じはしますが、ここまで述べたDDDの各種パターンを守った上で、Eloquentを採用することが設計上大きな障害に直結することは無いと思っています。</p>
<h2 id="所感">所感</h2>
<p>いいとされている設計手法には、きちんと目的や根拠があり、一種ルールがあります。</p>
<p>この「ルール」は、例えばレイヤー分けであったり、DDDのパターンであったりするんですが、基本的には「SOLID原則」や「カプセル化」のようなオブジェクト指向プログラミングにおける原則を守ることが重要だと思っています。</p>
<p>ルールを守ったうえで細部をどう実装するかについては好みの部分が出てきますが、新しい設計思想を採用する場合には、その思想の根幹にあるルールを理解しておくことが重要です。</p>
<h2 id="参考">参考</h2>
<p><a href="https://www.shoeisha.co.jp/book/detail/9784798126708">https://www.shoeisha.co.jp/book/detail/9784798126708</a><br>
<a href="https://www.ritolab.com/posts/185">https://www.ritolab.com/posts/185</a><br>
<a href="https://zenn.dev/kohii/articles/e4f325ed011db8">https://zenn.dev/kohii/articles/e4f325ed011db8</a><br>
<a href="https://zenn.dev/mpyw/articles/ce7d09eb6d8117">https://zenn.dev/mpyw/articles/ce7d09eb6d8117</a><br>
<a href="https://qiita.com/fuwasegu/items/f778a1067c941dc8baea">https://qiita.com/fuwasegu/items/f778a1067c941dc8baea</a><br>
<a href="https://blog.ytake.jp.net/entry/2015/12/16/011812">https://blog.ytake.jp.net/entry/2015/12/16/011812</a></p> </div> </div> <div class="footer"><div class="copyright">©︎ 2024 taisei miyaji</div><div class="icons"><span class="github"><a href="https://github.com/taiseimiyaji" target="_blank"><img src="/github-mark/github-mark-white.png" width="100%" height="100%" alt="github"/></a></span></div></div> </main> </body></html>